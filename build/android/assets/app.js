function line_intersects(e,t,o,n,a,i,r,d){var u,l,c,g;u=o-e,l=n-t,c=r-a,g=d-i;var f,m;f=(-l*(e-a)+u*(t-i))/(-c*l+u*g),m=(c*(t-i)-g*(e-a))/(-c*l+u*g),f>=0&&1>=f&&m>=0&&1>=m&&intersects++}function line_intersects(e,t,o,n,a,i,r,d){var u,l,c,g;u=o-e,l=n-t,c=r-a,g=d-i;var f,m;f=(-l*(e-a)+u*(t-i))/(-c*l+u*g),m=(c*(t-i)-g*(e-a))/(-c*l+u*g),f>=0&&1>=f&&m>=0&&1>=m&&intersects++}var win=Titanium.UI.createWindow({title:"Global911",backgroundColor:"#e6e8e6",exitOnClose:!0}),brandLabel=Titanium.UI.createLabel({backgroundColor:"#102E4A",top:0,height:80,width:"100%"}),brandImg=Titanium.UI.createImageView({image:"global911-mini.png",top:25,height:45});if("android"!==Ti.Platform.osname){win.add(brandLabel),win.add(brandImg);var height=90}else var height=10;var fileName="geodata.json",file=Titanium.Filesystem.getFile(Titanium.Filesystem.resourcesDirectory,fileName),json=file.read(),geodata=JSON.parse(json);Titanium.Geolocation.purpose="To identify user location for relevant local emergency services numbers",Titanium.Geolocation.accuracy=Titanium.Geolocation.ACCURACY_BEST,Titanium.Geolocation.distanceFilter=10;var longitude,latitude;if(Titanium.Geolocation.getCurrentPosition(function(e){return e.error?void alert("Global911 cannot get your current location. Please enable GPS Services (GPS Services do not use mobile or roaming data)"):(longitude=e.coords.longitude,void(latitude=e.coords.latitude))}),void 0!==latitude)if(Titanium.Network.networkType==Titanium.Network.NETWORK_NONE){var offlineLabel=Titanium.UI.createLabel({text:"Global911 is Working Offline",backgroundColor:"#102E4A",color:"#fff",bottom:0,height:"auto",padding:15,width:"100%",font:{fontSize:14}});win.add(offlineLabel);for(var intersects=null,found=null,i=0;i<geodata.length;i++){if("Polygon"==geodata[i].geometry.type){for(var j=0;j<geodata[i].geometry.coordinates[0].length;j++){var x1,x2,x3,x4,y1,y2,y3,y4;x1=90,y1=0,x2=latitude,y2=longitude,j+1==geodata[i].geometry.coordinates[0].length?(x3=geodata[i].geometry.coordinates[0][j][1],y3=geodata[i].geometry.coordinates[0][j][0],x4=geodata[i].geometry.coordinates[0][0][1],y4=geodata[i].geometry.coordinates[0][0][0]):(x3=geodata[i].geometry.coordinates[0][j][1],y3=geodata[i].geometry.coordinates[0][j][0],x4=geodata[i].geometry.coordinates[0][j+1][1],y4=geodata[i].geometry.coordinates[0][j+1][0]),line_intersects(x1,y1,x2,y2,x3,y3,x4,y4)}intersects>0&&intersects%2!=0&&(found=i)}if(null!=found)break;if("MultiPolygon"==geodata[i].geometry.type)for(var k=0;k<geodata[i].geometry.coordinates.length;k++){for(var l=0;l<geodata[i].geometry.coordinates[k][0].length;l++){var x1,x2,x3,x4,y1,y2,y3,y4;x1=90,y1=0,x2=latitude,y2=longitude,l+1==geodata[i].geometry.coordinates[k][0].length?(x3=geodata[i].geometry.coordinates[k][0][l][1],y3=geodata[i].geometry.coordinates[k][0][l][0],x4=geodata[i].geometry.coordinates[k][0][0][1],y4=geodata[i].geometry.coordinates[k][0][0][0]):(x3=geodata[i].geometry.coordinates[k][0][l][1],y3=geodata[i].geometry.coordinates[k][0][l][0],x4=geodata[i].geometry.coordinates[k][0][l+1][1],y4=geodata[i].geometry.coordinates[k][0][l+1][0]),line_intersects(x1,y1,x2,y2,x3,y3,x4,y4)}if(intersects>0&&intersects%2!=0){found=i;break}}if(null!=found)break}var locationLabel=Titanium.UI.createLabel({text:"Your Location: "+geodata[found].name,color:"#272727",top:height,height:60,width:"90%",font:{fontSize:18}}),numberLabel=Titanium.UI.createLabel({text:"Available Emergency Numbers: ",color:"#272727",top:height+70,height:20,width:"90%",font:{fontSize:18}}),policeButton=Titanium.UI.createButton({title:"Police: Dial "+geodata[found].number[0],backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+110,height:"auto",width:"60%",padding:15,font:{fontSize:18,fontWeight:"bold"}}),ambulanceButton=Titanium.UI.createButton({title:"Ambulance: Dial "+geodata[found].number[1],backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+170,height:"auto",width:"60%",padding:15,font:{fontSize:18,fontWeight:"bold"}}),fireButton=Titanium.UI.createButton({title:"Fire: Dial "+geodata[found].number[2],backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+230,height:"auto",padding:15,width:"60%",font:{fontSize:18,fontWeight:"bold"}}),noOptions=Titanium.UI.createLabel({text:"There are no known emergency numbers for the country you are in.",color:"#272727",top:height+110,height:40,width:"90%",font:{fontSize:18}}),singleNumber=Titanium.UI.createButton({title:"Dial "+geodata[found].number,backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+110,height:40,width:"60%",padding:15,font:{fontSize:18,fontWeight:"bold"}}),options=0;if(1==geodata[found].number.length)""!=geodata[found].number[0]&&win.add(singleNumber),options++;else for(var p=0;p<geodata[found].number.length;p++)0==p&&""!=geodata[found].number[p]&&(win.add(policeButton),options++),1==p&&""!=geodata[found].number[p]&&(win.add(ambulanceButton),options++),2==p&&""!=geodata[found].number[p]&&(win.add(fireButton),options++);0==options&&win.add(noOptions),policeButton.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[found].number[0])}),ambulanceButton.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[found].number[1])}),fireButton.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[found].number[2])}),singleNumber.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[found].number)}),win.add(locationLabel),win.add(numberLabel)}else{var country_code,countryID;Titanium.Geolocation.reverseGeocoder(latitude,longitude,function(e){function t(e){for(var t=0;geodata[t];){if(geodata[t].id===e)return country=geodata[t].name,t;t++}return country="Country Not Found"}if(e.success){var o=e.places;country_code=o&&o.length?o[0].country_code:"No country found"}countryID=t(country_code);var n=Titanium.UI.createLabel({text:"Your Location: "+country,color:"#272727",top:height,height:60,width:"90%",font:{fontSize:18}}),a=Titanium.UI.createLabel({text:"Available Emergency Numbers",color:"#272727",top:height+70,height:20,width:"90%",font:{fontSize:18}}),i=Titanium.UI.createButton({title:"Police: Dial "+geodata[countryID].number[0],backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+110,height:"auto",width:"60%",padding:15,font:{fontSize:18,fontWeight:"bold"}}),r=Titanium.UI.createButton({title:"Ambulance: Dial "+geodata[countryID].number[1],backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+170,height:"auto",width:"60%",padding:15,font:{fontSize:18,fontWeight:"bold"}}),d=Titanium.UI.createButton({title:"Fire: Dial "+geodata[countryID].number[2],backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+230,height:"auto",padding:15,width:"60%",font:{fontSize:18,fontWeight:"bold"}}),u=Titanium.UI.createLabel({text:"There are no known emergency numbers for the country you are in.",color:"#272727",top:height+110,height:40,width:"90%",font:{fontSize:18}}),l=Titanium.UI.createLabel({text:"Dial "+geodata[countryID].number,backgroundColor:"#2aabe1",color:"#fff",borderRadius:8,top:height+110,height:"auto",width:"60%",padding:15,textAlign:Ti.UI.TEXT_ALIGNMENT_CENTER,font:{fontSize:18,fontWeight:"bold"}}),c=0;if(1==geodata[countryID].number.length)""!=geodata[countryID].number[0]&&(win.add(l),c++);else for(var g=0;g<geodata[countryID].number.length;g++)0==g&&""!=geodata[countryID].number[g]&&(win.add(i),c++),1==g&&""!=geodata[countryID].number[g]&&(win.add(r),c++),2==g&&""!=geodata[countryID].number[g]&&(win.add(d),c++);0==c&&win.add(u),i.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[countryID].number[0])}),r.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[countryID].number[1])}),d.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[countryID].number[2])}),l.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[countryID].number)}),win.add(a),win.add(n)})}var noGPSLabel=Titanium.UI.createLabel({text:"Global911 cannot retrieve your GPS location",color:"#272727",top:height,height:60,width:"90%",font:{fontSize:18}});void 0==latitude&&win.add(noGPSLabel),win.open();