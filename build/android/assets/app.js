function line_intersects(e,t,o,n,i,a,r,d){var u,l,c,g;u=o-e,l=n-t,c=r-i,g=d-a;var m,f;m=(-l*(e-i)+u*(t-a))/(-c*l+u*g),f=(c*(t-a)-g*(e-i))/(-c*l+u*g),m>=0&&1>=m&&f>=0&&1>=f&&intersects++}function line_intersects(e,t,o,n,i,a,r,d){var u,l,c,g;u=o-e,l=n-t,c=r-i,g=d-a;var m,f;m=(-l*(e-i)+u*(t-a))/(-c*l+u*g),f=(c*(t-a)-g*(e-i))/(-c*l+u*g),m>=0&&1>=m&&f>=0&&1>=f&&intersects++}var win=Titanium.UI.createWindow({title:"Global911",backgroundColor:"#FFF",exitOnClose:!0}),brandLabel=Titanium.UI.createLabel({text:"Global911",color:"white",backgroundColor:"#e0483e",top:0,height:80,width:"100%",textAlign:Ti.UI.TEXT_ALIGNMENT_CENTER,font:{fontSize:24}});"android"!==Ti.Platform.osname&&win.add(brandLabel);var fileName="geodata.json",file=Titanium.Filesystem.getFile(Titanium.Filesystem.resourcesDirectory,fileName),json=file.read(),geodata=JSON.parse(json);Titanium.Geolocation.purpose="To identify user location for relevant local emergency services numbers",Titanium.Geolocation.accuracy=Titanium.Geolocation.ACCURACY_BEST,Titanium.Geolocation.distanceFilter=10;var longitude,latitude;if(Titanium.Geolocation.getCurrentPosition(function(e){return e.error?void alert("Global911 cannot get your current location. Please enable GPS Services (GPS Services do not use mobile or roaming data)"):(longitude=e.coords.longitude,void(latitude=e.coords.latitude))}),void 0!==latitude)if(Titanium.Network.networkType==Titanium.Network.NETWORK_NONE){var offlineLabel=Titanium.UI.createLabel({text:"Working Offline",bottom:0,height:"5%",width:"90%",font:{fontSize:18}});win.add(offlineLabel);for(var intersects=null,found=null,i=0;i<geodata.length;i++){if("Polygon"==geodata[i].geometry.type){for(var j=0;j<geodata[i].geometry.coordinates[0].length;j++){var x1,x2,x3,x4,y1,y2,y3,y4;x1=90,y1=0,x2=latitude,y2=longitude,j+1==geodata[i].geometry.coordinates[0].length?(x3=geodata[i].geometry.coordinates[0][j][1],y3=geodata[i].geometry.coordinates[0][j][0],x4=geodata[i].geometry.coordinates[0][0][1],y4=geodata[i].geometry.coordinates[0][0][0]):(x3=geodata[i].geometry.coordinates[0][j][1],y3=geodata[i].geometry.coordinates[0][j][0],x4=geodata[i].geometry.coordinates[0][j+1][1],y4=geodata[i].geometry.coordinates[0][j+1][0]),line_intersects(x1,y1,x2,y2,x3,y3,x4,y4)}intersects>0&&intersects%2!=0&&(found=i)}if(null!=found)break;if("MultiPolygon"==geodata[i].geometry.type)for(var k=0;k<geodata[i].geometry.coordinates.length;k++){for(var l=0;l<geodata[i].geometry.coordinates[k][0].length;l++){var x1,x2,x3,x4,y1,y2,y3,y4;x1=90,y1=0,x2=latitude,y2=longitude,l+1==geodata[i].geometry.coordinates[k][0].length?(x3=geodata[i].geometry.coordinates[k][0][l][1],y3=geodata[i].geometry.coordinates[k][0][l][0],x4=geodata[i].geometry.coordinates[k][0][0][1],y4=geodata[i].geometry.coordinates[k][0][0][0]):(x3=geodata[i].geometry.coordinates[k][0][l][1],y3=geodata[i].geometry.coordinates[k][0][l][0],x4=geodata[i].geometry.coordinates[k][0][l+1][1],y4=geodata[i].geometry.coordinates[k][0][l+1][0]),line_intersects(x1,y1,x2,y2,x3,y3,x4,y4)}if(intersects>0&&intersects%2!=0){found=i;break}}if(null!=found)break}var locationLabel=Titanium.UI.createLabel({text:"Your Location: "+geodata[found].name,top:90,height:60,width:"90%",font:{fontSize:18}}),numberLabel=Titanium.UI.createLabel({text:"Available Emergency Numbers: ",top:160,height:20,width:"90%",font:{fontSize:18}}),policeButton=Titanium.UI.createButton({title:"Police: Dial "+geodata[found].number[0],top:200,height:40,width:"90%",font:{fontSize:18}}),ambulanceButton=Titanium.UI.createButton({title:"Ambulance: Dial "+geodata[found].number[1],top:260,height:40,width:"90%",font:{fontSize:18}}),fireButton=Titanium.UI.createButton({title:"Fire: Dial "+geodata[found].number[2],top:320,height:40,width:"90%",font:{fontSize:18}}),noOptions=Titanium.UI.createLabel({text:"There are no known emergency numbers for the country you are in.",top:200,height:40,width:"90%",font:{fontSize:18}}),singleNumber=Titanium.UI.createLabel({text:"Dial "+geodata[found].number,top:200,height:40,width:"90%",font:{fontSize:18}}),options=0;if(1==geodata[found].number.length)win.add(singleNumber),options++;else for(var p=0;p<geodata[found].number.length;p++)0==p&&""!=geodata[found].number[p]&&(win.add(policeButton),options++),1==p&&""!=geodata[found].number[p]&&(win.add(ambulanceButton),options++),2==p&&""!=geodata[found].number[p]&&(win.add(fireButton),options++);0==options&&win.add(noOptions),policeButton.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[found].number[0])}),ambulanceButton.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[found].number[1])}),fireButton.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[found].number[2])}),win.add(locationLabel),win.add(numberLabel)}else{var country_code,countryID;Titanium.Geolocation.reverseGeocoder(latitude,longitude,function(e){function t(e){for(var t=0;geodata[t];){if(geodata[t].id===e)return country=geodata[t].name,t;t++}return country="Country Not Found"}if(e.success){var o=e.places;country_code=o&&o.length?o[0].country_code:"No country found"}countryID=t(country_code);var n=Titanium.UI.createLabel({text:"Your Location: "+country,top:"10%",height:"5%",width:"90%",font:{fontSize:18}}),i=Titanium.UI.createLabel({text:"Available Emergency Numbers",top:"30%",height:"5%",width:"90%",font:{fontSize:18}}),a=Titanium.UI.createButton({title:"Police: Dial "+geodata[countryID].number[0],top:200,height:40,width:"90%",font:{fontSize:18}}),r=Titanium.UI.createButton({title:"Ambulance: Dial "+geodata[countryID].number[1],top:260,height:40,width:"90%",font:{fontSize:18}}),d=Titanium.UI.createButton({title:"Fire: Dial "+geodata[countryID].number[2],top:320,height:40,width:"90%",font:{fontSize:18}}),u=Titanium.UI.createLabel({text:"There are no known emergency numbers for the country you are in.",top:200,height:40,width:"90%",font:{fontSize:18}}),l=Titanium.UI.createLabel({text:"Dial "+geodata[countryID].number,top:200,height:40,width:"90%",font:{fontSize:18}}),c=0;if(1==geodata[countryID].number.length)win.add(l),c++;else for(var g=0;g<geodata[countryID].number.length;g++)0==g&&""!=geodata[countryID].number[g]&&(win.add(a),c++),1==g&&""!=geodata[countryID].number[g]&&(win.add(r),c++),2==g&&""!=geodata[countryID].number[g]&&(win.add(d),c++);0==c&&win.add(u),a.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[countryID].number[0])}),r.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[countryID].number[1])}),d.addEventListener("click",function(){Titanium.Platform.openURL("tel:"+geodata[countryID].number[2])}),win.add(i),win.add(n)})}var noGPSLabel=Titanium.UI.createLabel({text:"Global911 cannot retrieve your GPS location",top:90,height:60,width:"90%",font:{fontSize:18}});void 0==latitude&&win.add(noGPSLabel),win.open();